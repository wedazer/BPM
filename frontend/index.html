<!doctype html>
<html lang="fr">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Analyse BPM</title>
  <style>
    :root { color-scheme: light dark; }
    * { box-sizing: border-box; }
    body {
      font-family: ui-sans-serif, system-ui, -apple-system, Segoe UI, Roboto, "Helvetica Neue", Arial, "Noto Sans", "Apple Color Emoji", "Segoe UI Emoji";
      margin: 0; min-height: 100svh; display: grid; place-items: center;
      background: radial-gradient(1200px 600px at 10% -10%, #a78bfa44 0%, #0000 60%),
                  radial-gradient(1200px 600px at 110% 110%, #60a5fa44 0%, #0000 60%),
                  linear-gradient(180deg, #0b1020, #0e1222);
      color: #e6e8ee;
      padding: 24px;
    }
    .container { width: min(980px, 96vw); display: grid; gap: 20px; }
    .header { display: flex; align-items: center; justify-content: space-between; }
    .title { font-size: 28px; font-weight: 800; letter-spacing: .3px; }
    .subtitle { opacity: .8; font-size: 14px; }
    .grid { display: grid; gap: 16px; grid-template-columns: 1fr; }
    @media (min-width: 880px) { .grid { grid-template-columns: 1fr 1fr; } }
    .card {
      border: 1px solid #ffffff1a; background: #0f1426cc; backdrop-filter: blur(8px);
      border-radius: 16px; padding: 18px; box-shadow: 0 10px 30px #00000040;
    }
    h1 { margin: 0 0 6px; font-size: 18px; }
    p { margin: 0 0 12px; opacity: .85; }
    label { font-weight: 600; font-size: 14px; }
    input[type="url"], input[type="file"] {
      width: 100%; margin: 8px 0 14px; padding: 12px 14px; border-radius: 12px;
      border: 1px solid #ffffff26; background: #0c1122; color: #e6e8ee;
      outline: none;
    }
    input[type="url"]:focus { border-color: #818cf8; box-shadow: 0 0 0 3px #6366f11f; }
    .row { display: flex; gap: 10px; align-items: center; flex-wrap: wrap; }
    button {
      padding: 10px 14px; border-radius: 12px; border: 1px solid #4f46e5;
      background: linear-gradient(180deg, #6366f1, #4f46e5); color: white; font-weight: 700;
      cursor: pointer; transition: transform .06s ease, filter .2s;
    }
    button:hover { filter: brightness(1.08); }
    button:active { transform: translateY(1px); }
    button.ghost { background: transparent; border-color: #ffffff33; color: #e6e8ee; }
    button:disabled { opacity: .6; cursor: not-allowed; }
    .result { font-size: 16px; font-weight: 700; margin-top: 8px; min-height: 24px; }
    .status { font-size: 13px; opacity: .8; min-height: 20px; }
    .progress { width: 100%; height: 10px; background: #ffffff12; border-radius: 999px; overflow: hidden; margin-top: 8px; display: none; }
    .bar { height: 100%; width: 0%; background: linear-gradient(90deg, #22d3ee, #818cf8); box-shadow: 0 0 12px #22d3ee80; transition: width .2s ease; }
    .eta { font-size: 12px; opacity: .75; margin-top: 6px; display: none; }
    .footer { opacity: .65; font-size: 12px; text-align: center; margin-top: 8px; }
    .badge { font-size: 12px; padding: 4px 8px; border: 1px solid #ffffff22; border-radius: 999px; }
  </style>
</head>
<body>
  <div class="container">
    <div class="header">
      <div>
        <div class="title">Analyse BPM</div>
        <div class="subtitle">Collez un lien (YouTube, TikTok, Instagram, Twitter, MP4, MP3, etc.) ou uploadez un fichier.</div>
      </div>
      <div class="badge">Multi-plateformes</div>
    </div>

    <div class="grid">
      <div class="card">
        <h1>Analyse d'un lien</h1>
        <p>Détecte automatiquement la source et extrait l'audio.</p>
        <label for="url">URL</label>
        <input id="url" type="url" placeholder="https://..." />
        <div class="row">
          <button id="analyzeUrl">Analyser le lien</button>
          <button id="cancelUrl" class="ghost">Annuler</button>
          <button id="clearUrl" class="ghost">Effacer</button>
          <span id="statusUrl" class="status"></span>
        </div>
        <div id="progUrl" class="progress"><div class="bar" id="barUrl"></div></div>
        <div id="etaUrl" class="eta"></div>
        <div id="resultUrl" class="result"></div>
      </div>

      <div class="card">
        <h1>Analyse d'un fichier</h1>
        <p>Accepte mp3, wav, aac, m4a, mp4, etc.</p>
        <label for="file">Fichier</label>
        <input id="file" type="file" />
        <div class="row">
          <button id="analyzeFile">Analyser le fichier</button>
          <button id="cancelFile" class="ghost">Annuler</button>
          <button id="clearFile" class="ghost">Effacer</button>
          <span id="statusFile" class="status"></span>
        </div>
        <div id="progFile" class="progress"><div class="bar" id="barFile"></div></div>
        <div id="etaFile" class="eta"></div>
        <div id="resultFile" class="result"></div>
      </div>
    </div>

    <div class="footer">Backend: status <span id="statusPing">…</span></div>
  </div>

  <script>
    const API = (location.origin.includes('localhost') || location.origin.includes('127.0.0.1'))
      ? 'http://127.0.0.1:8000' // local dev
      : 'https://site-bpm-backend.onrender.com'; // production backend

    async function ping() {
      try {
        const r = await fetch(`${API}/status`);
        if (!r.ok) throw new Error('offline');
        document.getElementById('statusPing').textContent = 'OK';
      } catch(e) {
        console.warn('Backend /status unreachable:', e);
        document.getElementById('statusPing').textContent = 'indisponible';
      }
    }
    ping();

    const $ = (id) => document.getElementById(id);

    function formatETA(sec) {
      sec = Math.max(0, Math.ceil(sec));
      if (sec < 60) return `${sec}s restantes`;
      const m = Math.floor(sec / 60), s = sec % 60;
      return `${m}m ${s}s restants`;
    }

    function startProgress(prefix, typicalSeconds = 35) {
      const bar = $(`bar${prefix}`);
      const wrap = $(`prog${prefix}`);
      const eta = $(`eta${prefix}`);
      wrap.style.display = 'block';
      eta.style.display = 'block';
      const start = performance.now();
      let raf = null, running = true;
      function tick() {
        if (!running) return;
        const elapsed = (performance.now() - start) / 1000;
        // cap at 95% to keep some headroom until completion
        const pct = Math.min(95, (elapsed / typicalSeconds) * 100);
        bar.style.width = `${pct}%`;
        const remain = typicalSeconds - elapsed;
        eta.textContent = remain <= 0 ? 'Toujours en cours…' : formatETA(remain);
        raf = requestAnimationFrame(tick);
      }
      tick();
      return {
        done: () => {
          running = false;
          if (raf) cancelAnimationFrame(raf);
          bar.style.width = '100%';
          eta.textContent = 'Terminé';
          setTimeout(() => { wrap.style.display = 'none'; eta.style.display = 'none'; bar.style.width = '0%'; }, 1200);
        },
        fail: () => {
          running = false;
          if (raf) cancelAnimationFrame(raf);
          eta.textContent = 'Échec';
          setTimeout(() => { wrap.style.display = 'none'; eta.style.display = 'none'; bar.style.width = '0%'; }, 1500);
        }
      };
    }

    let urlController = null;
    let fileController = null;

    $('analyzeUrl').addEventListener('click', async () => {
      const url = $('url').value.trim();
      if (!url) { $('statusUrl').textContent = 'Veuillez entrer une URL.'; return; }
      $('statusUrl').textContent = 'Analyse en cours…';
      $('analyzeUrl').disabled = true;
      $('clearUrl').disabled = true;
      $('cancelUrl').disabled = false;
      $('url').disabled = true;
      $('resultUrl').textContent = '';
      const prog = startProgress('Url', 45);
      try {
        urlController = new AbortController();
        const r = await fetch(`${API}/bpm/url`, {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ url }),
          signal: urlController.signal
        });
        if (!r.ok) {
          const txt = await r.text().catch(() => '');
          throw new Error(`HTTP ${r.status} ${r.statusText}${txt ? ` — ${txt}` : ''}`);
        }
        const data = await r.json();
        if (data.bpm) {
          $('resultUrl').textContent = `BPM: ${data.bpm}` + (data.confidence !== undefined ? ` (fiabilité ~ ${Math.round(data.confidence*100)}%)` : '');
          prog.done();
        } else if (data.error) {
          $('resultUrl').textContent = `Erreur: ${data.error}${data.details ? ' — ' + data.details : ''}`;
          prog.fail();
        } else {
          $('resultUrl').textContent = 'Réponse inattendue.';
          prog.fail();
        }
      } catch (e) {
        $('resultUrl').textContent = `Erreur réseau${e && e.message ? ` — ${e.name === 'AbortError' ? 'requête annulée' : e.message}` : ''}`;
        prog.fail();
      } finally {
        $('statusUrl').textContent = '';
        $('analyzeUrl').disabled = false;
        $('clearUrl').disabled = false;
        $('cancelUrl').disabled = true;
        $('url').disabled = false;
        urlController = null;
      }
    });
    $('clearUrl').addEventListener('click', () => { $('url').value = ''; $('resultUrl').textContent = ''; $('statusUrl').textContent = ''; });
    $('cancelUrl').addEventListener('click', () => { try { urlController && urlController.abort(); } catch(_){} });

    $('analyzeFile').addEventListener('click', async () => {
      const f = $('file').files[0];
      if (!f) { $('statusFile').textContent = 'Veuillez choisir un fichier.'; return; }
      $('statusFile').textContent = 'Analyse en cours…';
      $('analyzeFile').disabled = true;
      $('clearFile').disabled = true;
      $('cancelFile').disabled = false;
      $('file').disabled = true;
      $('resultFile').textContent = '';
      const prog = startProgress('File', 45);
      try {
        const fd = new FormData();
        fd.append('file', f);
        fileController = new AbortController();
        const r = await fetch(`${API}/bpm/upload`, { method: 'POST', body: fd, signal: fileController.signal });
        if (!r.ok) {
          const txt = await r.text().catch(() => '');
          throw new Error(`HTTP ${r.status} ${r.statusText}${txt ? ` — ${txt}` : ''}`);
        }
        const data = await r.json();
        if (data.bpm) {
          $('resultFile').textContent = `BPM: ${data.bpm}` + (data.confidence !== undefined ? ` (fiabilité ~ ${Math.round(data.confidence*100)}%)` : '');
          prog.done();
        } else if (data.error) {
          $('resultFile').textContent = `Erreur: ${data.error}${data.details ? ' — ' + data.details : ''}`;
          prog.fail();
        } else {
          $('resultFile').textContent = 'Réponse inattendue.';
          prog.fail();
        }
      } catch (e) {
        $('resultFile').textContent = `Erreur réseau${e && e.message ? ` — ${e.name === 'AbortError' ? 'requête annulée' : e.message}` : ''}`;
        prog.fail();
      } finally {
        $('statusFile').textContent = '';
        $('analyzeFile').disabled = false;
        $('clearFile').disabled = false;
        $('cancelFile').disabled = true;
        $('file').disabled = false;
        fileController = null;
      }
    });
    $('clearFile').addEventListener('click', () => { $('file').value = ''; $('resultFile').textContent = ''; $('statusFile').textContent = ''; });
    $('cancelFile').addEventListener('click', () => { try { fileController && fileController.abort(); } catch(_){} });
  </script>
</body>
</html>
